name: Update Task List
on:
  issues:
    types: [opened, edited, closed, reopened, labeled, unlabeled]
  workflow_dispatch: # Esto nos permite darle a un botÃ³n para probar

jobs:
  update-status-file:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Verificar archivos
        run: ls -R # Esto imprimirÃ¡ en la consola quÃ© archivos ve el bot

      - name: Update ESTADO.md
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const filename = 'ESTADO.md';
            
            // Comprobamos si el archivo existe antes de fallar
            if (!fs.existsSync(filename)) {
              throw new Error(`Â¡Error! No encuentro el archivo ${filename} en la raÃ­z.`);
            }

            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all'
            });

            let content = "";
            const groups = ['Grupo 2', 'Grupo 4'];
            
            groups.forEach(group => {
              content += `### ðŸ‘¥ ${group}\n`;
              const groupIssues = issues.data.filter(i => i.labels.some(l => l.name === group));
              if (groupIssues.length === 0) {
                content += "- _No hay tareas asignadas._\n";
              } else {
                groupIssues.forEach(issue => {
                  const check = issue.state === 'closed' ? '[x]' : '[ ]';
                  content += `- ${check} ${issue.title} (#${issue.number})\n`;
                });
              }
              content += "\n";
            });

            const fileContent = fs.readFileSync(filename, 'utf8');
            
            // Esto busca los marcadores y solo cambia lo que hay entre ellos
            const startMarker = '';
            const endMarker = '';
            
            const regex = new RegExp(`${startMarker}[\\s\\S]*${endMarker}`);
            const newFileContent = fileContent.replace(
              regex,
              `${startMarker}\n${content}${endMarker}`
            );
            
            fs.writeFileSync(filename, newFileContent);
            
      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          git add ESTADO.md
          git commit -m "Sistema: Actualizado" || echo "Sin cambios"
          git push
