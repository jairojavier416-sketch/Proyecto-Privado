name: Update Task List
on:
  issues:
    types: [opened, edited, closed, reopened, labeled, unlabeled]
  workflow_dispatch:

jobs:
  create-pr-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: read
    steps:
      - uses: actions/checkout@v3

      - name: Generar Lista
        uses: actions/github-script@v6
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all'
            });

            let content = "# üìã Control de Tareas por Grupo\n\n";
            const groups = ['Grupo 2', 'Grupo 4'];
            
            groups.forEach(group => {
              content += `## üë• ${group}\n`;
              const groupIssues = issues.data.filter(i => i.labels.some(l => l.name === group));
              if (groupIssues.length === 0) {
                content += "- _No hay tareas asignadas a√∫n._\n";
              } else {
                groupIssues.forEach(issue => {
                  const status = issue.state === 'closed' ? '[x]' : '[ ]';
                  content += `- ${status} ${issue.title} (#${issue.number})\n`;
                });
              }
              content += "\n";
            });
            require('fs').writeFileSync('ESTADO.md', content);

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Sistema: Actualizar lista de tareas"
          title: "ü§ñ Actualizaci√≥n autom√°tica de ESTADO.md"
          body: "Este es un mensaje autom√°tico del bot para actualizar la lista de tareas seg√∫n los √∫ltimos cambios en las Issues."
          branch: update-tasks-bot
          base: main
          delete-branch: true
